<html>
<body>
    <h1>The onclick Event</h1>
    <button onclick="myFunction()">Click Me</button>
    <p></p>
    <div id="demo">Demo</div>
    <script type="text/javascript">
        let reportNames = [
            "och",
            "csampprovisioning",
            "shelves",
            "networkelements",
            "equipment",
            "oms",
            "ccmd",
            "vp",
            "linkenggerrorsandwarnings",
            "equipmentGroup",
            "Sncs",
            "domain",
            "PhotonicSrlg",
            "CcmdLocProvisioning",
            "opsSncps",
            "photonicservices",
            "PassiveProvisioning",
            "photonicSncgs",
            "DwdmAdjacencies",
            "L0ControlPlane",
            "DifferentialProvisioning",
            "Ports",
            "PhotonicOsrp/links",
            "PhotonicOsrp/lines",
            "PhotonicOsrp/sncs",
            "PhotonicOsrp/sncps",
            "Dtl/paths",
            "Dtl/sets",
            "MediaChannel",
            "Dtl/txInfos",
            "fiberrunlistreport",
            "planningProjects/reports",
            "fibers/report"
        ];

        async function myFunction() {

            var exitCriteria = false;

            reportNames.forEach(async (reportName, index) => {
                if (exitCriteria) {
                    console.log('Exiting loop ..');
                    return;
                }

                if (reportName != "equipment") {
                    return;
                }

                document.getElementById("demo").innerHTML = "Hello World <br>";
                let uriReportSchema = 'https://localhost/equipmenttopologyplanning/api/v1/Reports/schema?reportName=' + reportName;

                console.log('Calling schema for ' + reportName);

                await fetch(
                    uriReportSchema,
                    {
                        //mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    }
                )
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("demo").innerHTML += "[" + index + "] " + reportName + " - " + uriReportSchema + "<br>";
                        let reportSchema = JSON.parse(data);
                        console.log(reportSchema);

                        let projectId = '3289f54a-2b62-4e27-bb77-e59836edc2bb';

                        //let columnNameForTextFilter = "siteID";
                        //let reportingParamsText = '{"startRow":0,"endRow":400,"rowGroupCols":[],"valueCols":[],"pivotCols":[],"pivotMode":false,"groupKeys":[],"filterModel":[{"column":"' + columnNameForTextFilter + '","key":"r1","filterType":"text","type":"equals","filter":10,"filterTo":null,"values":[10]}],"sortModel":[],"pageSize":400,"pageNumber":1,"filterExpression":"( r1 )"}';
                        //let reportingParamsNumber = '{"startRow":0,"endRow":400,"rowGroupCols":[],"valueCols":[],"pivotCols":[],"pivotMode":false,"groupKeys":[],"filterModel":[{"column":"' + columnNameForTextFilter + '","key":"r1","filterType":"number","type":"equals","filter":10,"filterTo":null,"values":[10]}],"sortModel":[{"column":"node_siteName","sort":"asc"},{"column":"node_tid","sort":"asc"}],"pageSize":400,"pageNumber":1,"filterExpression":"( r1 )"}';
                        //let reportingParamsDate = '{"startRow":0,"endRow":400,"rowGroupCols":[],"valueCols":[],"pivotCols":[],"pivotMode":false,"groupKeys":[],"filterModel":[{"column":"' + columnNameForTextFilter + '","key":"r1","filterType":"number","type":"equals","filter":10,"filterTo":null,"values":[10]},{"column":"planningState_planningTimestamp","key":"r2","dateTo":null,"dateFrom":"2015-01-21","type":"equals","filterType":"date","values":[null]}],"sortModel":[{"column":"node_siteName","sort":"asc"},{"column":"node_tid","sort":"asc"}],"pageSize":400,"pageNumber":1,"filterExpression":"( r1 and r2 )"}';

                        let reportDataUriBase = 'https://localhost/equipmenttopologyplanning/api/v1/Reports/equipment/' + projectId + "?useNetworkDescriptions=true";

                        let gridDataNoFilter;
                        let reportingParamsNoFilter = '{"startRow":0,"endRow":400,"rowGroupCols":[],"valueCols":[],"pivotCols":[],"pivotMode":false,"groupKeys":[],"filterModel":[],"sortModel":[],"pageSize":400,"pageNumber":1,"filterExpression":""}';
                        let reportDataUriNoFilter = reportDataUriBase + '&reportingParams=' + reportingParamsNoFilter;
                        //console.log('Calling ' + reportName + ' with no filters ..');

                        fetch(
                            reportDataUriNoFilter,
                            {
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            }
                        )
                            .then(response => response.json())
                            .then(gridData => {
                                gridDataNoFilter = gridData;
                                //console.log('Grid data with no filters');
                                //console.log(gridDataNoFilter);

                                // We have the grid data response with no filters

                                console.log('Checking properties for ' + reportName);

                                for (propKey in reportSchema.properties) {
                                    let prop = reportSchema.properties[propKey];
                                    type = prop.type; // Eg "string"
                                    if (prop.hasOwnProperty("meta")) {
                                        if (prop.meta.properties.hasOwnProperty("actualDataType")) {
                                            actualDataType = prop.meta.properties.actualDataType; // Eg "date"
                                        }
                                    }

                                    // Case 1: type=integer
                                    // Call with Text Filter, then with Number Filter

                                    let gridDataTextFilter;
                                    let gridDataNumberFilter;
                                    let columnName = propKey;

                                    if (type === "integer" || type === "number") {
                                        let filterValue;
                                        let filteredData = gridDataNoFilter.data.filter(p => p.hasOwnProperty(columnName) && p[columnName] !== null);
                                        if (gridDataNoFilter.data.length > 0 && (filteredData !== undefined && filteredData.length > 0)) {
                                            filterValue = gridDataNoFilter.data.filter(p => p[columnName] != null)[0][columnName];

                                            let reportingParamsTextFilter = '{"startRow":0,"endRow":400,"rowGroupCols":[],"valueCols":[],"pivotCols":[],"pivotMode":false,"groupKeys":[],"filterModel":[{"column":"' + columnName + '","key":"r1","filterType":"text","type":"equals","filterTo":null,"values":[' + filterValue + ']}],"sortModel":[],"pageSize":400,"pageNumber":1,"filterExpression":"( r1 )"}';
                                            let reportingParamsNumberFilter = '{"startRow":0,"endRow":400,"rowGroupCols":[],"valueCols":[],"pivotCols":[],"pivotMode":false,"groupKeys":[],"filterModel":[{"column":"' + columnName + '","key":"r1","filterType":"number","type":"equals","filterTo":null,"values":[' + filterValue + ']}],"sortModel":[{"column":"node_siteName","sort":"asc"},{"column":"node_tid","sort":"asc"}],"pageSize":400,"pageNumber":1,"filterExpression":"( r1 )"}';
                                            let reportDataUriTextFilter = reportDataUriBase + '&reportingParams=' + reportingParamsTextFilter;
                                            let reportDataUriNumberFilter = reportDataUriBase + '&reportingParams=' + reportingParamsNumberFilter;

                                            // Call Text Filter
                                            //console.log('Calling report: ' + reportName + ', column: ' + columnName + ', Text filter: ' + filterValue);
                                            fetch(
                                                reportDataUriTextFilter,
                                                {
                                                    headers: {
                                                        'Content-Type': 'application/json',
                                                    }
                                                }
                                            )
                                                .then(response => response.json())
                                                .then(gridData => {
                                                    gridDataTextFilter = gridData;
                                                    //console.log(gridDataTextFilter);


                                                    // Call Number Filter
                                                    //console.log('Calling report: ' + reportName + ', column: ' + columnName + ', Number filter: ' + filterValue);
                                                    fetch(
                                                        reportDataUriTextFilter,
                                                        {
                                                            headers: {
                                                                'Content-Type': 'application/json',
                                                            }
                                                        }
                                                    )
                                                        .then(response => response.json())
                                                        .then(gridData => {
                                                            gridDataNumberFilter = gridData;
                                                            //console.log(gridDataNumberFilter);

                                                            // We got both text and number filter results
                                                            // Time to do some comparison
                                                            //console.log('Compare text and number results for ' + reportName + ', filterValue = ' + filterValue);
                                                            if (JSON.stringify(gridDataTextFilter) === JSON.stringify(gridDataNumberFilter)) {
                                                                console.log('Match ! Report: ' + reportName + ', column: ' + columnName + ', type = ' + type + ', filterValue = ' + filterValue);
                                                            }
                                                            else {
                                                                console.log('Match Failed ! Report: ' + reportName + ', column: ' + columnName + ', type = ' + type + ', filterValue = ' + filterValue);
                                                            }


                                                            exitCriteria = true;
                                                        })
                                                        .catch((err) => {
                                                            // Err in calling Number Filter
                                                            exitCriteria = true;
                                                            console.log(err);
                                                        });


                                                })
                                                .catch((err) => {
                                                    // Err in calling Text Filter
                                                    exitCriteria = true;
                                                    console.log(err);
                                                });

                                            if (exitCriteria) {
                                                return;
                                            }

                                        }
                                    }
                                };


                                if (exitCriteria) {
                                    return;
                                }
                            })
                            .catch((err) => {
                                // Err in calling grid with no filters
                                exitCriteria = true;
                                console.log(err);
                            });

                    })
                    .catch((err) => {
                        // Error in GET Schema
                        exitCriteria = true;
                        console.log(err);
                    });
            });

            console.log('Done ..');
        }
    </script>
</body>
</html>
